<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portfolio Creator</title>
    <style>
      :root {
        --bg: #f5f7fb;
        --panel: #ffffff;
        --text: #0f172a;
        --muted: #64748b;
        --border: #e2e8f0;
        --accent: #2563eb;
        --accent-weak: rgba(37, 99, 235, 0.12);
        --danger: #ef4444;
        --success: #16a34a;
        --shadow: 0 10px 30px rgba(2, 6, 23, 0.08);
        --radius: 14px;
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          "Helvetica Neue",
          Arial,
          "Noto Sans",
          "Apple Color Emoji",
          "Segoe UI Emoji";
        background: var(--bg);
        color: var(--text);
        padding: 24px;
      }

      .container { max-width: 1100px; margin: 0 auto; }

      header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 18px;
      }
      h1 { margin: 0; font-size: 20px; letter-spacing: -0.01em; }
      .subtitle { font-size: 13px; color: var(--muted); }

      .tabs {
        display: inline-flex;
        border: 1px solid var(--border);
        border-radius: 999px;
        background: var(--panel);
        padding: 4px;
        gap: 4px;
      }
      .tab-btn {
        border: 0;
        background: transparent;
        padding: 10px 14px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 13px;
        cursor: pointer;
        color: var(--muted);
        transition: background 0.15s, color 0.15s;
      }
      .tab-btn.active { background: var(--accent-weak); color: var(--accent); }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 18px;
      }

      .section { display: none; }
      .section.active { display: block; }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }
      @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

      .form-group { display: flex; flex-direction: column; gap: 6px; }

      label { font-size: 12px; font-weight: 800; color: var(--text); }
      .hint { font-size: 12px; color: var(--muted); }

      input[type="text"],
      input[type="date"],
      input[type="number"],
      textarea,
      select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
        font: inherit;
        font-size: 14px;
        background: #fff;
        outline: none;
        transition: border-color 0.15s, box-shadow 0.15s;
      }
      textarea { min-height: 140px; resize: vertical; }
      input:focus, textarea:focus, select:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 4px var(--accent-weak);
      }

      .status {
        display: none;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        margin-bottom: 14px;
        font-size: 13px;
      }
      .status.show { display: block; }
      .status.success { border-color: rgba(22,163,74,0.25); background: rgba(22,163,74,0.08); color: var(--success); }
      .status.error { border-color: rgba(239,68,68,0.25); background: rgba(239,68,68,0.08); color: var(--danger); }

      .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

      .btn {
        border: 1px solid var(--border);
        background: #fff;
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 700;
        font-size: 13px;
        transition: transform 0.03s, background 0.15s, border-color 0.15s;
      }
      .btn:active { transform: translateY(1px); }
      .btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
      .btn.ghost:hover { background: #f1f5f9; }
      .btn.danger { background: var(--danger); border-color: var(--danger); color: #fff; }

      .divider { height: 1px; background: var(--border); margin: 14px 0; }

      .category-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 8px;
      }
      .category-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #fff;
      }
      .category-item input { width: 16px; height: 16px; }
      .category-item label { margin: 0; font-size: 13px; font-weight: 700; color: var(--text); }

      .block-editor { display: flex; flex-direction: column; gap: 10px; }
      .block { display: grid; grid-template-columns: 130px 1fr 36px; gap: 10px; align-items: start; }
      .block select, .block textarea, .block input[type="text"] { width: 100%; }
      .block textarea { min-height: 90px; }

      .file-name { font-size: 12px; color: var(--muted); }
      .image-preview { max-width: 100%; max-height: 260px; border-radius: 12px; border: 1px solid var(--border); background: #fff; }

      .section-title { font-size: 14px; font-weight: 800; margin-bottom: 10px; }

      .setting-row { display: flex; align-items: center; gap: 10px; }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div>
          <h1>Portfolio Creator</h1>
          <div class="subtitle">Articles, Pages, Categories, and Uploads</div>
        </div>
        <div class="tabs" role="tablist" aria-label="Content type">
          <button class="tab-btn active" onclick="switchTab(event, 'article')" type="button">Article</button>
          <button class="tab-btn" onclick="switchTab(event, 'page')" type="button">Page</button>
          <button class="tab-btn" onclick="switchTab(event, 'category')" type="button">Category</button>
          <button class="tab-btn" onclick="switchTab(event, 'settings')" type="button">Settings</button>
        </div>
      </header>
      <section id="article" class="section active">
        <div class="panel">
          <div id="articleStatus" class="status"></div>

          <div class="grid">
            <div class="form-group">
              <label>Edit Existing Article</label>
              <select id="articleSelect" onchange="loadArticle()">
                <option value="">-- Create New --</option>
              </select>
            </div>
            <div class="form-group">
              <label>Date *</label>
              <input type="date" id="articleDate" />
            </div>
            <div class="form-group">
              <label>Title *</label>
              <input type="text" id="articleTitle" placeholder="Article title" />
            </div>
            <div class="form-group">
              <label>Slug *</label>
              <input type="text" id="articleSlug" placeholder="article-url-slug" />
            </div>
          </div>

          <div class="divider"></div>

          <div class="grid">
            <div class="form-group">
              <label>Cover Image *</label>
              <input type="file" id="coverImage" accept="image/*" />
              <div id="coverFileName" class="file-name"></div>
              <img id="coverPreview" class="image-preview" style="display:none" />
            </div>
            <div class="form-group">
              <label>Categories *</label>
              <div id="categoriesList" class="category-list"></div>
              <div class="hint">Pick at least 1 category.</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="form-group">
            <label>Index this article</label>
            <input type="checkbox" id="articleIndexed" checked />
          </div>

          <div class="divider"></div>

          <div class="form-group">
            <div class="section-title">Content blocks</div>
            <div id="articleBlockEditor" class="block-editor"></div>
            <div class="row" style="margin-top: 8px;">
              <button class="btn" type="button" onclick="addArticleBlock()">Add block</button>
            </div>
          </div>

          <div class="row" style="margin-top: 14px;">
            <button class="btn primary" onclick="publishArticle()" type="button">Publish</button>
            <button class="btn danger" id="deleteArticleBtn" onclick="deleteArticle()" type="button" style="display:none">Delete</button>
            <button class="btn ghost" onclick="resetArticle()" type="button">Reset</button>
          </div>
        </div>
      </section>

      <section id="page" class="section">
        <div class="panel">
          <div id="pageStatus" class="status"></div>

          <div class="grid">
            <div class="form-group">
              <label>Edit Existing Page</label>
              <select id="pageSelect" onchange="loadPage()">
                <option value="">-- Create New --</option>
              </select>
            </div>
            <div class="form-group">
              <label>Menu Order</label>
              <input type="number" id="pageOrder" placeholder="0" />
            </div>
            <div class="form-group">
              <label>Title *</label>
              <input type="text" id="pageTitle" placeholder="Page title" />
            </div>
            <div class="form-group">
              <label>Slug *</label>
              <input type="text" id="pageSlug" placeholder="page-url-slug" />
            </div>
          </div>

          <div class="divider"></div>

          <div class="grid">
            <div class="form-group">
              <label>Page Cover Image</label>
              <input type="file" id="pageImage" accept="image/*" />
              <div id="pageImageName" class="file-name"></div>
            </div>
            <div class="form-group">
              <label>Page Type *</label>
              <div class="row">
                <label><input type="radio" name="pageType" value="content" checked onchange="togglePageType()" /> Content blocks</label>
                <label><input type="radio" name="pageType" value="pdf" onchange="togglePageType()" /> PDF file</label>
              </div>
            </div>
          </div>

          <div id="pageContentFields">
            <div class="form-group">
              <div class="section-title">Content blocks</div>
              <div id="pageBlockEditor" class="block-editor"></div>
              <div class="row" style="margin-top: 8px;">
                <button class="btn" type="button" onclick="addPageBlock()">Add block</button>
              </div>
            </div>
          </div>

          <div id="pagePdfFields" style="display:none">
            <div class="form-group">
              <label>PDF File *</label>
              <input type="file" id="pagePdfFile" accept=".pdf" />
              <div id="pagePdfName" class="file-name"></div>
            </div>
          </div>

          <div class="row" style="margin-top: 14px;">
            <button class="btn primary" onclick="publishPage()" type="button">Publish</button>
            <button class="btn danger" id="deletePageBtn" onclick="deletePage()" type="button" style="display:none">Delete</button>
            <button class="btn ghost" onclick="resetPage()" type="button">Reset</button>
          </div>
        </div>
      </section>

      <section id="category" class="section">
        <div class="panel">
          <div id="categoryStatus" class="status"></div>

          <div class="grid">
            <div class="form-group">
              <label>Category Name *</label>
              <input type="text" id="categoryName" placeholder="Category name" />
            </div>
            <div class="form-group">
              <label>Category Image</label>
              <input type="file" id="categoryImage" accept="image/*" />
              <div id="categoryImageName" class="file-name"></div>
            </div>
          </div>

          <div class="row" style="margin-top: 12px;">
            <button class="btn primary" onclick="createCategory()" type="button">Create Category</button>
            <button class="btn ghost" onclick="resetCategory()" type="button">Reset</button>
          </div>

          <div class="divider"></div>

          <div class="section-title">Existing Categories</div>
          <div id="categoryList" class="category-list"></div>
        </div>
      </section>

      <section id="settings" class="section">
        <div class="panel">
          <div class="section-title">API Settings</div>
          <div class="form-group">
            <label>API Base URL</label>
            <div class="setting-row">
              <input type="text" id="apiUrlInput" placeholder="https://api.example.com/api" />
              <button class="btn" onclick="saveApiUrl()" type="button">Save</button>
            </div>
            <div class="hint">Current: <span id="apiUrlLabel"></span></div>
          </div>
        </div>
      </section>
    </div>

    <script>
      const DEFAULT_API_URL = "http://localhost:3000/api";
      const API_URL = localStorage.getItem("apiUrl") || DEFAULT_API_URL;

      const state = {
        categories: [],
        selectedCategories: [],
        currentArticleId: null,
        currentPageId: null,
        coverImage: null,
        pageImage: null,
        pagePdfFile: null,
        categoryImage: null,
      };

      const BLOCK_TYPES = [
        { value: "paragraph", label: "Paragraph" },
        { value: "heading1", label: "Heading 1" },
        { value: "heading2", label: "Heading 2" },
        { value: "heading3", label: "Heading 3" },
        { value: "quote", label: "Quote" },
        { value: "list", label: "List" },
        { value: "code", label: "Code" },
        { value: "image", label: "Image" },
        { value: "pdf", label: "PDF" },
      ];
      const BLOCK_TYPE_SET = new Set(BLOCK_TYPES.map((t) => t.value));
      const normalizeType = (value) => {
        if (!value) return "paragraph";
        if (value === "subtitle") return "heading1";
        if (value === "header") return "heading2";
        return BLOCK_TYPE_SET.has(value) ? value : "paragraph";
      };

      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("apiUrlLabel").textContent = API_URL;
        document.getElementById("apiUrlInput").value = API_URL;
        setTodaysDate();
        loadCategories();
        loadExistingArticles();
        loadExistingPages();
        setupUploads();
        initEditors();
      });

      function switchTab(e, tab) {
        document.querySelectorAll(".section").forEach((s) => s.classList.remove("active"));
        document.querySelectorAll(".tab-btn").forEach((b) => b.classList.remove("active"));
        document.getElementById(tab).classList.add("active");
        e.currentTarget.classList.add("active");
      }

      function showStatus(elementId, message, type) {
        const el = document.getElementById(elementId);
        el.textContent = message;
        el.className = `status show ${type}`;
        if (type === "success") {
          setTimeout(() => (el.className = "status"), 2200);
        }
      }

      async function request(path, options = {}) {
        const res = await fetch(`${API_URL}/${path}`, options);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || "Request failed");
        }
        const contentType = res.headers.get("content-type") || "";
        if (contentType.includes("application/json")) return res.json();
        return res.text();
      }

      function saveApiUrl() {
        const value = document.getElementById("apiUrlInput").value.trim();
        if (!value) return;
        localStorage.setItem("apiUrl", value);
        location.reload();
      }

      function setTodaysDate() {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("articleDate").value = today;
      }

      function setupUploads() {
        document.getElementById("coverImage").addEventListener("change", (e) => {
          state.coverImage = e.target.files[0] || null;
          document.getElementById("coverFileName").textContent = state.coverImage
            ? `Selected: ${state.coverImage.name}`
            : "";
          if (state.coverImage) {
            const reader = new FileReader();
            reader.onload = (event) => {
              const preview = document.getElementById("coverPreview");
              preview.src = event.target.result;
              preview.style.display = "block";
            };
            reader.readAsDataURL(state.coverImage);
          }
        });

        document.getElementById("pageImage").addEventListener("change", (e) => {
          state.pageImage = e.target.files[0] || null;
          document.getElementById("pageImageName").textContent = state.pageImage
            ? `Selected: ${state.pageImage.name}`
            : "";
        });

        document.getElementById("pagePdfFile").addEventListener("change", (e) => {
          state.pagePdfFile = e.target.files[0] || null;
          document.getElementById("pagePdfName").textContent = state.pagePdfFile
            ? `Selected: ${state.pagePdfFile.name}`
            : "";
        });

        document.getElementById("categoryImage").addEventListener("change", (e) => {
          state.categoryImage = e.target.files[0] || null;
          document.getElementById("categoryImageName").textContent = state.categoryImage
            ? `Selected: ${state.categoryImage.name}`
            : "";
        });
      }

      function initEditors() {
        document.getElementById("articleBlockEditor").innerHTML = "";
        document.getElementById("pageBlockEditor").innerHTML = "";
        addBlock(document.getElementById("articleBlockEditor"));
        addBlock(document.getElementById("pageBlockEditor"));
      }

      function createBlockRow(defaultType = "paragraph", initialValue = "", initialFile = "") {
        const block = document.createElement("div");
        block.className = "block";
        block.dataset.value = initialValue || "";
        block.dataset.currentFile = initialFile || "";

        const typeSelect = document.createElement("select");
        BLOCK_TYPES.forEach((t) => {
          const opt = document.createElement("option");
          opt.value = t.value;
          opt.textContent = t.label;
          typeSelect.appendChild(opt);
        });
        typeSelect.value = normalizeType(defaultType);

        const inputContainer = document.createElement("div");
        const removeBtn = document.createElement("button");
        removeBtn.className = "btn ghost";
        removeBtn.textContent = "X";
        removeBtn.type = "button";
        removeBtn.onclick = () => block.remove();

        const renderInput = () => {
          inputContainer.innerHTML = "";
          const type = typeSelect.value;
          if (type === "image" || type === "pdf") {
            const fileInput = document.createElement("input");
            fileInput.type = "file";
            fileInput.accept = type === "image" ? "image/*" : ".pdf";
            fileInput.className = "block-input";
            inputContainer.appendChild(fileInput);

            const helper = document.createElement("div");
            helper.className = "file-name";
            helper.textContent = block.dataset.currentFile ? `Current: ${block.dataset.currentFile}` : "";
            fileInput.addEventListener("change", () => {
              helper.textContent = fileInput.files[0]
                ? `Selected: ${fileInput.files[0].name}`
                : block.dataset.currentFile
                  ? `Current: ${block.dataset.currentFile}`
                  : "";
            });
            inputContainer.appendChild(helper);
          } else if (type === "list" || type === "code" || type === "paragraph" || type === "quote") {
            const textarea = document.createElement("textarea");
            textarea.className = "block-input";
            textarea.placeholder = type === "list" ? "One item per line" : "";
            textarea.value = block.dataset.value || "";
            inputContainer.appendChild(textarea);
          } else {
            const input = document.createElement("input");
            input.type = "text";
            input.className = "block-input";
            input.value = block.dataset.value || "";
            inputContainer.appendChild(input);
          }
        };

        typeSelect.addEventListener("change", () => {
          block.dataset.value = "";
          block.dataset.currentFile = block.dataset.currentFile || "";
          renderInput();
        });

        block.appendChild(typeSelect);
        block.appendChild(inputContainer);
        block.appendChild(removeBtn);
        renderInput();
        return block;
      }

      function addBlock(editor, type, initialValue, initialFile) {
        editor.appendChild(createBlockRow(type, initialValue, initialFile));
      }

      function addArticleBlock() {
        addBlock(document.getElementById("articleBlockEditor"));
      }

      function addPageBlock() {
        addBlock(document.getElementById("pageBlockEditor"));
      }

      function collectBlocks(editor) {
        const blocks = [];
        const imageFiles = [];
        const pdfFiles = [];

        editor.querySelectorAll(".block").forEach((block) => {
          const type = block.querySelector("select").value;
          const input = block.querySelector(".block-input");
          let data = "";

          if (type === "image" || type === "pdf") {
            const file = input.files && input.files[0] ? input.files[0] : null;
            const currentFile = block.dataset.currentFile || "";
            data = currentFile || "";
            if (file) {
              if (type === "image") imageFiles.push(file);
              if (type === "pdf") pdfFiles.push(file);
            }
          } else if (type === "list") {
            const items = input.value
              .split("\n")
              .map((line) => line.trim())
              .filter(Boolean);
            data = items;
          } else {
            data = input.value.trim();
          }

          blocks.push({ type, data });
        });

        return { blocks, imageFiles, pdfFiles };
      }

      function togglePageType() {
        const mode = document.querySelector('input[name="pageType"]:checked').value;
        document.getElementById("pageContentFields").style.display = mode === "content" ? "block" : "none";
        document.getElementById("pagePdfFields").style.display = mode === "pdf" ? "block" : "none";
      }

      async function loadCategories() {
        try {
          const data = await request("catagories");
          state.categories = Array.isArray(data) ? data : [];
          renderCategories();
          renderCategoryList();
        } catch (err) {
          console.error(err);
        }
      }

      function renderCategories() {
        const container = document.getElementById("categoriesList");
        container.innerHTML = state.categories
          .map(
            (cat) => `
          <div class="category-item">
            <input type="checkbox" id="cat-${cat._id}" value="${cat._id}" onchange="toggleCategory('${cat._id}')">
            <label for="cat-${cat._id}">${cat.name}</label>
          </div>
        `,
          )
          .join("");
      }

      function renderCategoryList() {
        const container = document.getElementById("categoryList");
        container.innerHTML = state.categories
          .map(
            (cat) => `
          <div class="category-item">
            <span>${cat.name}</span>
          </div>
        `,
          )
          .join("");
      }

      function toggleCategory(id) {
        const checkbox = document.getElementById(`cat-${id}`);
        if (checkbox.checked) {
          if (!state.selectedCategories.includes(id)) state.selectedCategories.push(id);
        } else {
          state.selectedCategories = state.selectedCategories.filter((c) => c !== id);
        }
      }

      async function createCategory() {
        const name = document.getElementById("categoryName").value.trim();
        if (!name) {
          showStatus("categoryStatus", "Name is required", "error");
          return;
        }
        try {
          const formData = new FormData();
          formData.append("name", name);
          if (state.categoryImage) {
            formData.append("imageFile", state.categoryImage);
          } else {
            formData.append("imageURI", "default");
          }

          await request("catagories/add", { method: "POST", body: formData });
          showStatus("categoryStatus", "Category created", "success");
          resetCategory();
          loadCategories();
        } catch (err) {
          showStatus("categoryStatus", "Error: " + err.message, "error");
        }
      }

      function resetCategory() {
        document.getElementById("categoryName").value = "";
        document.getElementById("categoryImage").value = "";
        document.getElementById("categoryImageName").textContent = "";
        state.categoryImage = null;
      }
      async function loadExistingArticles() {
        try {
          const data = await request("article");
          const select = document.getElementById("articleSelect");
          select.innerHTML =
            '<option value="">-- Create New --</option>' +
            (Array.isArray(data) ? data : [])
              .map(
                (a) =>
                  `<option value="${a._id}">${a.title} (${new Date(a.date).toLocaleDateString()})</option>`,
              )
              .join("");
        } catch (err) {
          console.error(err);
        }
      }

      async function loadArticle() {
        const id = document.getElementById("articleSelect").value;
        if (!id) return resetArticle();
        try {
          const article = await request(`article/id/${id}`);
          state.currentArticleId = article._id;
          document.getElementById("articleTitle").value = article.title || "";
          document.getElementById("articleSlug").value = article.slug || "";
          document.getElementById("articleDate").value = (article.date || "").split("T")[0];
          document.getElementById("articleIndexed").checked = article.isIndexed ?? true;

          state.selectedCategories = article.catagories || [];
          document.querySelectorAll('input[id^="cat-"]').forEach((cb) => {
            cb.checked = state.selectedCategories.includes(cb.value);
          });

          if (article.imageURI) {
            const preview = document.getElementById("coverPreview");
            preview.src = article.imageURI;
            preview.style.display = "block";
          }

          const editor = document.getElementById("articleBlockEditor");
          editor.innerHTML = "";
          (article.elements || []).forEach((element) => {
            const type = normalizeType(element.type);
            if (type === "image" || type === "pdf") {
              editor.appendChild(createBlockRow(type, "", element.data || ""));
              return;
            }
            if (type === "list") {
              const listValue = Array.isArray(element.data)
                ? element.data.join("\n")
                : (element.data || "");
              editor.appendChild(createBlockRow(type, listValue, ""));
              return;
            }
            editor.appendChild(createBlockRow(type, element.data || "", ""));
          });
          if (editor.children.length === 0) addBlock(editor);

          document.getElementById("deleteArticleBtn").style.display = "inline-flex";
        } catch (err) {
          showStatus("articleStatus", "Error loading article", "error");
        }
      }

      async function publishArticle() {
        const title = document.getElementById("articleTitle").value.trim();
        const slug = document.getElementById("articleSlug").value.trim();
        const date = document.getElementById("articleDate").value;
        const isIndexed = document.getElementById("articleIndexed").checked;

        if (!title || !slug || !date || state.selectedCategories.length === 0) {
          showStatus("articleStatus", "Title, slug, date, and categories are required", "error");
          return;
        }

        const { blocks, imageFiles, pdfFiles } = collectBlocks(
          document.getElementById("articleBlockEditor"),
        );

        if (!blocks.length) {
          showStatus("articleStatus", "Add at least 1 block", "error");
          return;
        }

        try {
          const formData = new FormData();
          formData.append("title", title);
          formData.append("slug", slug);
          formData.append("date", date);
          formData.append("isIndexed", isIndexed.toString());
          formData.append("elements", JSON.stringify(blocks));

          state.selectedCategories.forEach((cat) => formData.append("catagories", cat));

          if (state.coverImage) {
            formData.append("imageFile", state.coverImage);
          } else {
            const existing = document.getElementById("coverPreview").src || "default";
            formData.append("imageURI", existing);
          }

          imageFiles.forEach((file) => formData.append("imageFiles", file));
          pdfFiles.forEach((file) => formData.append("pdfFiles", file));

          const method = state.currentArticleId ? "PUT" : "POST";
          const endpoint = state.currentArticleId ? `article/${state.currentArticleId}` : "article/add";
          await request(endpoint, { method, body: formData });

          showStatus("articleStatus", state.currentArticleId ? "Article updated" : "Article published", "success");
          loadExistingArticles();
          resetArticle();
        } catch (err) {
          showStatus("articleStatus", "Error: " + err.message, "error");
        }
      }

      function resetArticle() {
        state.currentArticleId = null;
        state.coverImage = null;
        state.selectedCategories = [];
        document.getElementById("articleSelect").value = "";
        document.getElementById("articleTitle").value = "";
        document.getElementById("articleSlug").value = "";
        document.getElementById("coverImage").value = "";
        document.getElementById("coverFileName").textContent = "";
        document.getElementById("coverPreview").style.display = "none";
        document.getElementById("coverPreview").src = "";
        document.getElementById("deleteArticleBtn").style.display = "none";
        document.querySelectorAll('input[id^="cat-"]').forEach((cb) => (cb.checked = false));
        document.getElementById("articleBlockEditor").innerHTML = "";
        addBlock(document.getElementById("articleBlockEditor"));
        setTodaysDate();
      }

      async function deleteArticle() {
        if (!state.currentArticleId) return;
        if (!confirm("Delete this article?")) return;
        try {
          await request(`article/${state.currentArticleId}`, { method: "DELETE" });
          showStatus("articleStatus", "Article deleted", "success");
          loadExistingArticles();
          resetArticle();
        } catch (err) {
          showStatus("articleStatus", "Error: " + err.message, "error");
        }
      }

      async function loadExistingPages() {
        try {
          const data = await request("pages");
          const select = document.getElementById("pageSelect");
          select.innerHTML =
            '<option value="">-- Create New --</option>' +
            (Array.isArray(data) ? data : [])
              .map((p) => `<option value="${p._id}">${p.title} (Order: ${p.order ?? 0})</option>`)
              .join("");
        } catch (err) {
          console.error(err);
        }
      }

      async function loadPage() {
        const id = document.getElementById("pageSelect").value;
        if (!id) return resetPage();
        try {
          const page = await request(`pages/id/${id}`);
          state.currentPageId = page._id;
          document.getElementById("pageTitle").value = page.title || "";
          document.getElementById("pageSlug").value = page.slug || "";
          document.getElementById("pageOrder").value = page.order ?? 0;

          if (page.pdfFile) {
            document.querySelector('input[value="pdf"]').checked = true;
            togglePageType();
            document.getElementById("pagePdfName").textContent = `Current: ${page.pdfFile}`;
          } else {
            document.querySelector('input[value="content"]').checked = true;
            togglePageType();
          }

          const editor = document.getElementById("pageBlockEditor");
          editor.innerHTML = "";
          (page.elements || []).forEach((element) => {
            const type = normalizeType(element.type);
            if (type === "image" || type === "pdf") {
              editor.appendChild(createBlockRow(type, "", element.data || ""));
              return;
            }
            if (type === "list") {
              const listValue = Array.isArray(element.data)
                ? element.data.join("\n")
                : (element.data || "");
              editor.appendChild(createBlockRow(type, listValue, ""));
              return;
            }
            editor.appendChild(createBlockRow(type, element.data || "", ""));
          });
          if (editor.children.length === 0) addBlock(editor);

          document.getElementById("deletePageBtn").style.display = "inline-flex";
        } catch (err) {
          showStatus("pageStatus", "Error loading page", "error");
        }
      }

      async function publishPage() {
        const title = document.getElementById("pageTitle").value.trim();
        const slug = document.getElementById("pageSlug").value.trim();
        const order = parseInt(document.getElementById("pageOrder").value, 10) || 0;
        const mode = document.querySelector('input[name="pageType"]:checked').value;

        if (!title || !slug) {
          showStatus("pageStatus", "Title and slug are required", "error");
          return;
        }

        try {
          if (mode === "pdf") {
            const formData = new FormData();
            formData.append("title", title);
            formData.append("slug", slug);
            formData.append("order", order);
            if (state.pageImage) formData.append("imageFile", state.pageImage);
            if (state.pagePdfFile) formData.append("pdfFile", state.pagePdfFile);

            const endpoint = state.currentPageId ? `pages/${state.currentPageId}` : "pages/add";
            const method = state.currentPageId ? "PUT" : "POST";
            await request(endpoint, { method, body: formData });
          } else {
            const { blocks, imageFiles, pdfFiles } = collectBlocks(
              document.getElementById("pageBlockEditor"),
            );
            const formData = new FormData();
            formData.append("title", title);
            formData.append("slug", slug);
            formData.append("order", order);
            formData.append("elements", JSON.stringify(blocks));
            if (state.pageImage) formData.append("imageFile", state.pageImage);
            imageFiles.forEach((file) => formData.append("imageFiles", file));
            pdfFiles.forEach((file) => formData.append("pdfFiles", file));

            const endpoint = state.currentPageId ? `pages/${state.currentPageId}` : "pages/add";
            const method = state.currentPageId ? "PUT" : "POST";
            await request(endpoint, { method, body: formData });
          }

          showStatus("pageStatus", state.currentPageId ? "Page updated" : "Page created", "success");
          loadExistingPages();
          resetPage();
        } catch (err) {
          showStatus("pageStatus", "Error: " + err.message, "error");
        }
      }

      function resetPage() {
        state.currentPageId = null;
        state.pageImage = null;
        state.pagePdfFile = null;
        document.getElementById("pageSelect").value = "";
        document.getElementById("pageTitle").value = "";
        document.getElementById("pageSlug").value = "";
        document.getElementById("pageOrder").value = "0";
        document.getElementById("pageImage").value = "";
        document.getElementById("pagePdfFile").value = "";
        document.getElementById("pageImageName").textContent = "";
        document.getElementById("pagePdfName").textContent = "";
        document.querySelector('input[value="content"]').checked = true;
        togglePageType();
        document.getElementById("pageBlockEditor").innerHTML = "";
        addBlock(document.getElementById("pageBlockEditor"));
        document.getElementById("deletePageBtn").style.display = "none";
      }

      async function deletePage() {
        if (!state.currentPageId) return;
        if (!confirm("Delete this page?")) return;
        try {
          await request(`pages/${state.currentPageId}`, { method: "DELETE" });
          showStatus("pageStatus", "Page deleted", "success");
          loadExistingPages();
          resetPage();
        } catch (err) {
          showStatus("pageStatus", "Error: " + err.message, "error");
        }
      }
    </script>
  </body>
</html>
